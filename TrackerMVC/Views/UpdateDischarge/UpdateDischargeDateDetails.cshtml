@model IEnumerable<TrackerMVCEntities.BusinessEntities.DischargeDateContainerDetails>
@{
    ViewBag.Title = "UpdateDischargeDateDetails";
    Layout = "~/Views/Shared/_LayoutDashboard.cshtml";
}

<div class=" content-area">
    <div class="page-header">
        <h4 class="page-title">Update Discharge Date: <label id="lblcount">@Model.Count()</label> </h4>
        @*<ol class="breadcrumb">
            <li class="breadcrumb-item"><a class="btn btn-primary btn-success" style="color:white;align-content:center;"><i class="fa fa-arrow-left" data-placement="bottom" title="Back"></i>  </a></li>

        </ol>*@
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="form-horizontal">
                        <div class="row">
                            <div class="col-lg-6 col-sm-12">
                                <div class="row">
                                    <div class="col-lg-6 col-sm-12">
                                        <div class="form-group">
                                            <div class="row gutters-xs">
                                                <div class="col">
                                                    @* <input name=txtContainerNo placeholder="Container No." class="form-control" type="text" />*@
                                                    @Html.TextBox("txtContainerNo", null, new { @class = "form-control ", placeholder = "Container No.", onblur = "myRequiredValidation('txtContainerNo')", maxlength = 11 })

                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-4 col-sm-12">
                                        <div class="form-group">
                                            <div class="row gutters-xs">
                                                <div class="col">
                                                    <button class="btn btn-primary" style="width:60PX" id="btnSearch" type="button"><i class="fe fe-search"></i></button>
                                                    <button class="btn btn-primary" id="btnView" style="display:none" type="button">View all</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-lg-6 col-sm-12">
                                        <div class="form-group">
                                            <div class="row gutters-xs">
                                                <div class="col">
                                                    @*<input name=txtDischargeDate class="form-control RemovalDateTime"  type="text" />*@
                                                    @Html.TextBox("txtDischargeDate", null, new { @class = "form-control RemovalDateTime", @Value = DateTime.Now.ToString("dd MMM yyyy HH:mm") })
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-2 col-sm-12">
                                        <div class="form-group">
                                            <div class="row gutters-xs">
                                                <div class="col">
                                                    <button class="btn btn-success" id="btnSave" type="button">Save</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 col-sm-12">

                                <div class="card">
                                    OR Import from Excel
                                    <div class="card-body">

                                        <div class="row">
                                            <div class="col-lg-6 col-sm-12">
                                                <div class="form-group">
                                                    <div class="row gutters-xs">
                                                        <div class="col">
                                                            <input type="file" id="fileImport" name="postedFile" />
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-lg-2 col-sm-12">
                                                <div class="form-group">
                                                    <div class="row gutters-xs">
                                                        <div class="col">
                                                            <input type="Button" id="btnImport" value="Import" class="btn btn-primary" />
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-2 col-sm-12" id="divTEUS" style="display:none">
                                <div class="form-group">
                                    <label class="form-label" style="visibility:hidden"> '</label>
                                    <div class="row gutters-xs">
                                        <div class="col">
                                            <span style="font-weight: bold"> 20 :</span> <label id="lbltwenty" style="font-weight: bold"></label>

                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-lg-2 col-sm-12" id="divTEUS1" style="display:none">
                                <div class="form-group">
                                    <label class="form-label" style="visibility:hidden"> '</label>
                                    <div class="row gutters-xs">
                                        <div class="col">
                                            <span style="font-weight: bold"> 40 :</span> <label id="lblforty" style="font-weight: bold"></label>

                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-sm-12" id="divTEUS2" style="display:none">
                                <div class="form-group">
                                    <label class="form-label" style="visibility:hidden"> '</label>
                                    <div class="row gutters-xs">
                                        <div class="col">
                                            <span style="font-weight: bold"> 45 :</span> <label id="lblfortyfive" style="font-weight: bold"></label>

                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-sm-12" id="divTEUS3" style="display:none">
                                <div class="form-group">
                                    <label class="form-label" style="visibility:hidden"> '</label>
                                    <div class="row gutters-xs">
                                        <div class="col">
                                            <span style="font-weight: bold"> TEUS :</span>   <label id="lblTotal" style="font-weight: bold"></label>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <div class="row">
                            <div class="col-lg-12 col-sm-12">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover tbl-cart text-nowrap" id="example1" style="width:100%;">
                                        <thead>
                                            <tr>
                                                <th class="wd-10p sorting">JO No.</th>
                                                <th class="wd-10p sorting ">Container No.</th>
                                                <th class="wd-10p sorting">Size </th>
                                                <th class="wd-10p sorting">Port </th>
                                                <th class="wd-10p sorting">Discharge Date</th>
                                            </tr>
                                        </thead>
                                        <tbody style="box-sizing :border-box;">
                                            @foreach (var d in Model)
                                            {

                                                <tr>
                                                    <td>@d.JONO <input name=hdJONO type=hidden id=JONO value='@d.JONO'></td>
                                                    <td>@d.ContainerNO <input name=hdContainerNO type=hidden id=ContainerNO value='@d.ContainerNO'></td>
                                                    <td>@d.Size </td>
                                                    <td>@d.port  </td>
                                                    <td>@d.DischargeDate</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                    </div>
            </div>
        </div>
    </div>
</div>
</div>
<script>
    $(document).ready(function () {
        $('#example1').dataTable({
            "bLengthChange": false,
            "bInfo": false,
            "bPaginate": false,
            "bFilter": false,
            "paging": false
          
        })


        var table = document.getElementById("example1");

        var row;


        var TotTEUS1 = 0;
        var TotTEUS2 = 0;
        var TotTEUS3 = 0;
        var TotTEUS = 0;

        for (var i = 1; i < table.rows.length; i++) {
            row = table.rows[i];
            //var Size = row.cells[6].childNodes[1].value;
            var Size = row.cells[2].innerText;

            //alert(Size)

            if (Size == 20) {
                TotTEUS1 = Number(TotTEUS1) + 1;
            }
            if (Size == 40) {
                TotTEUS2 = Number(TotTEUS2) + 2;
            }
            if (Size == 45) {
                TotTEUS3 = Number(TotTEUS3) + 2;
            }
            //TotTEUS = Number(TotTEUS) + Number(size);


        }
        TotTEUS = TotTEUS1 + TotTEUS2 + TotTEUS3
        // alert(TotTEUS);
        $("#lbltwenty").text(TotTEUS1);
        $("#lblforty").text(TotTEUS2);
        $("#lblfortyfive").text(TotTEUS3);
        $("#lblTotal").text(TotTEUS);

        $("#divTEUS").show();
        $("#divTEUS1").show();
        $("#divTEUS2").show();
        $("#divTEUS3").show();
    });
</script>

<script>

    var input = document.getElementById("txtContainerNo");
    input.addEventListener("keyup", function (event) {
        if (event.keyCode === 13) {
            event.preventDefault();
            document.getElementById("btnSearch").click();
        }
    });

    $("#btnSearch").click(function () {
        
        var res = Validation();
        //  alert(res)
        if (res == false) {
            return false;
        }
        getUpdateDischargeData();
    });

    $("#btnView").click(function () {

       
        getUpdateDischargeData();
    });
</script>



<script>
    function Validation() {
        var txtContainerNo = document.getElementById('txtContainerNo').value;
        var blResult = Boolean;
        blResult = true;

        if (txtContainerNo == "") {
            //  document.getElementById('ContainerNo').style.borderColor = "red"
            $("#txtContainerNo").removeClass("form-control is-valid state-valid")
            $("#txtContainerNo").addClass("form-control is-invalid state-invalid")
            blResult = blResult && false;
        }
        if (blResult == false) { alert('Please fill the required fields!'); }
        return blResult;

    }
</script>

<script>
    function myRequiredValidation(TextField) {

        // alert("#" + TextField);

        if ($("#" + TextField).val() == "") {
            $("#" + TextField).removeClass("form-control is-valid state-valid")
            $("#" + TextField).addClass("form-control is-invalid state-invalid")
            //  document.getElementById(TextField).style.borderColor = "red"
        } else {
            // alert("hi")
            $("#" + TextField).removeClass("form-control is-invalid state-invalid")
            $("#" + TextField).addClass("form-control is-valid state-valid")
            // document.getElementById(TextField).style.borderColor = "Gainsboro"
        }
    };
</script>


<script>
    var input = document.getElementById("txtDischargeDate");
    input.addEventListener("keyup", function (event) {
        if (event.keyCode === 13) {
            event.preventDefault();
            document.getElementById("btnSave").click();
        }
    });

    
    $("#btnSave").click(function () {

        var containerNo = $('#txtContainerNo').val();
        var res = Validation();
        //  alert(res)
        if (res == false) {
            return false;
        }
       
        var res1 = CheckValidContainer();
        //  alert(res)
        if (res1 == false) {
            return false;
        }

        var DischargeList = new Array();
        var DischargeList = [];
        var table = document.getElementById("example1");
        var row;
        for (var i = 1; i < table.rows.length; i++) {
            //  alert("hi")
            row = table.rows[i];
            var x = row.cells[0].childNodes[1].value;
            var y = row.cells[1].childNodes[1].value;
            var z = $('#txtDischargeDate').val()
            // alert(x);
            DischargeList.push({ 'JONO': x, 'ContainerNO': y, 'DischargeDate':z })
        }
       // alert(JSON.stringify(DischargeList))

        $.ajax({
            type: 'POST',
            url: '/UpdateDischarge/SaveDischargeData',
            data: '{ DischargeList: ' + JSON.stringify(DischargeList) + '}',
            //data: JSON.stringify(formData),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            async: true,
            success: function (data) {

                alert(data);
                $('#txtContainerNo').val("");
                $("#txtContainerNo").removeClass("form-control is-valid state-valid")
                $("#txtContainerNo").addClass("form-control")

                document.getElementById("btnView").click();
            }
        })
    });


</script>
<script>
    function CheckValidContainer() {
        var containerNo = $('#txtContainerNo').val();

        var table = document.getElementById("example1");
        var row;
        for (var i = 1; i < table.rows.length; i++) {
            row = table.rows[i];           
            var x = row.cells[1].childNodes[1].value;
           // alert(x)
                if (containerNo != row.cells[1].childNodes[1].value) {
                 //   alert(containerNo)
                  //  alert(row.cells[1].childNodes[1].value)
                    alert("Please click on Search Button");
                    return false;
                }
            
        }
        return true;
    }
</script>
<script>
    function getUpdateDischargeData()
    {
        var containerNo = $('#txtContainerNo').val();
        var data1 = { 'containerNo': containerNo };
        var data = JSON.stringify(data1);
        $.ajax({
            url: "/UpdateDischarge/ContainerWiseUpdateDischargeData",
            data: data,
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (data) {
               // var table = Object.keys(data).length;
                var count = Object.keys(data).length;
                $("#lblcount").text(count);

                $('#example1').dataTable({
                    "destroy": true,
                    "bLengthChange": false,
                    "bInfo": false,
                    "bPaginate": false,
                    "bFilter": false,
                    "paging": false,
                    "aaData": data,
                    "columns": [
                        //{ "data": "JONO" },
                       {
                           "data": "JONO",
                           "render": function (data, type, row, meta) {

                               input = '<input type=\"hidden\" name=\"hdJONO\" class=\" form-control \" id=\"JONO\" value="' + row.JONO + '">';
                               return data + input;
                           }
                       },
                        {
                            "data": "ContainerNO",
                            "render": function (data, type, row, meta) {

                                input = '<input type=\"hidden\" name=\"hdContainerNO\" class=\" form-control \" id=\"ContainerNO\" value="' + row.ContainerNO + '">';
                                return data + input;
                            }
                        },
                        { "data": "Size" },
                        { "data": "port" },
                        { "data": "DischargeDate" }

                    ]
                })
              

            },
            error: function (errormessage) {
                alert("error");
                alert(errormessage.responseText);
            }
        });
    }
</script>

<script>
    $(document).ready(function () {
        $('#btnImport').click(function () {
                   
            if (window.FormData !== undefined) {

                var fileUpload = $("#fileImport").get(0);
                var files = fileUpload.files;

                // Create FormData object
                var fileData = new FormData();
                if (files.length == 0) {
                    alert("Please select File!")
                    return false;
                }
                else {
                    // Looping over all files and add it to FormData object
                    for (var i = 0; i < files.length; i++) {

                        fileData.append(files[i].name, files[i]);
                    }


                    // Adding one more key to FormData object
                   // fileData.append('JONo', JONo);
                    // alert("hi")
                    $.ajax({
                        url: '/UpdateDischarge/ImportFile',

                        
                        type: "POST",
                        contentType: false, // Not to set any content header
                        processData: false, // Not to process data
                        data: fileData,
                        success: function (data) {
                           // alert(JSON.stringify(data));
                          //  var str = data;
                            var str = JSON.stringify(data.Issuedata);
                           //    alert(str);

                            var a = data.Issuedata.ColumnData;
                            var b = data.Issuedata.ValueData;
                            if (str != 1) {
                                alert("Inconsistent data found in excel template. \nColumn: " + a + "\nValue: " + b + "\nplease check and try re-importing.")
                                // alert("Some Invalid data in File.");
                            }
                            else {
                                alert(data.message)
                                $('#txtContainerNo').val("");
                                $("#txtContainerNo").removeClass("form-control is-valid state-valid")
                                $("#txtContainerNo").addClass("form-control")

                                document.getElementById("btnView").click();
                            }
                        }

                    });

                }

            }
            else {
                alert("FormData is not supported.");
            }
            $("#fileImport").val('');
        });
    });
</script>